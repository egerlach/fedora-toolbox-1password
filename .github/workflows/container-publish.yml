name: Publish Container Image

on:
  schedule:
    - cron: '43 8 * * *'
  push:
    paths-ignore:
      - '*.md'
      - 'LICENSE'

env:
  REGISTRY_USER: ${{ github.actor }}
  REGISTRY_PASSWORD: ${{ github.token }}
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}
  IMAGE_NAME: fedora-toolbox-1password
  AUTH_SECRET: registry_auth_file

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Computed environment variables
        run: |
          echo "FULL_IMAGE=${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}" >> "$GITHUB_ENV"
          echo "skopeo_inspect=podman run --secret ${{ env.AUTH_SECRET }} quay.io/skopeo/stable:latest inspect --authfile /run/secrets/${{ env.AUTH_SECRET }}" >> "$GITHUB_ENV"
          
      - name: Checkout repository
        uses: actions/checkout@v4

      # This step publishes a $REGISTRY_AUTH_FILE environment variable
      - name: Log in to GitHub Container Registry
        uses: redhat-actions/podman-login@v1
        with:
          username: ${{ env.REGISTRY_USER }}
          password: ${{ env.REGISTRY_PASSWORD }}
          registry: ${{ env.IMAGE_REGISTRY }}

      # Using secret for skopeo login as per: https://github.com/containers/image_build/blob/main/skopeo/README.md
      - name: Create secret from podman login
        run: |
          podman secret create ${{ env.AUTH_SECRET }} $REGISTRY_AUTH_FILE

      - name: Get base image version
        id: base_image
        run: |
          # Extract base image name from Containerfile
          BASE_IMAGE=$(grep -m1 FROM Containerfile | cut -d ' ' -f 2)
          echo "Base Image is: $BASE_IMAGE"
          echo "name=$BASE_IMAGE" >> "$GITHUB_OUTPUT"
          VERSION=$(${{ env.skopeo_inspect }} --format "{{slice .Digest 7}}" docker://$BASE_IMAGE)
          echo "Base Image Version is: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Set target label
        id: target_label
        run: |
          base_version=${{ steps.base_image.outputs.version }}
          sha=${{ github.sha }}
          TARGET_LABEL=base-${base_version:0:10}-git-${sha:0:10}
          echo "Target Label: $TARGET_LABEL"
          echo "label=$TARGET_LABEL" >> "$GITHUB_OUTPUT"

      - name: Check if that version of this image exists
        id: check
        # Using secret for skopeo login as per: https://github.com/containers/image_build/blob/main/skopeo/README.md
        run: |
          if ${{ env.skopeo_inspect }} --format "{{.Name}}" docker://${{ env.FULL_IMAGE }}:${{ steps.target_label.outputs.label }}; then
            echo "Build already exists, skipping build."
            SHOULD_BUILD=false
          else
            echo "Build does not exist, buildingâ€¦"
            SHOULD_BUILD=true
          fi
          echo "should_build=$SHOULD_BUILD" >> "$GITHUB_OUTPUT"

      - name: Buildah Action
        id: build_image
        uses: redhat-actions/buildah-build@v2
        with:
          image: ${{ env.IMAGE_NAME }}
          tags: latest ${{ steps.target_label.outputs.label }}
          containerfiles: |
            ./Containerfile

      - name: Push To GHCR
        uses: redhat-actions/push-to-registry@v2
        id: push
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          image: ${{ steps.build_image.outputs.image }}
          tags: ${{ steps.build_image.outputs.tags }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ env.REGISTRY_PASSWORD }}
          extra-args: |
            --disable-content-trust

      - run: echo "${{ toJson(steps) }}"
